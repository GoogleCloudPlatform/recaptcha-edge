<!DOCTYPE html>
<html>
<head>
  <title>Credentials</title>
  <script src="https://www.google.com/recaptcha/enterprise.js?render={{siteKey}}"></script>
</head>
<body>
  <h2>Credentials</h2>
  <div>
    <button id="execute-button">Execute</button>
    <input id="action-input" type="text" placeholder="Action/URL" />
  </div>
  <br>
  <section>
    <h3>Please fill out this form:</h3>
    <form id="login-form" method="POST">
      <label for="firstName">First Name:</label>
      <input name="firstName" id="firstName" type="text" autocomplete="given-name">
      <br>

      <label for="lastName">Last Name:</label>
      <input name="lastName" id="lastName" type="text" autocomplete="family-name">
      <br>

      <label for="email">Email:</label>
      <input name="email" id="email" type="email" autocomplete="email">
      <br>

      <label for="username">Username:</label>
      <input name="username" id="username" type="text" autocomplete="username">
      <br>

      <button id="check-username">Check if username is available</button>
      <br>

      <label for="password">Password:</label>
      <input name="password" id="password" type="password" autocomplete="new-password">
      <br>

      <label for="action">Action:</label>
      <input name="action" id="action" type="text" value="login">
      <br>

      <input id="submit" type="submit" value="Submit"/>
    </form>
  </section>
  <br>
  <div id="response-from-promise"></div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
    function showResponse(id, resp) {
        const el = document.getElementById(id);
        if (el) {
            el.textContent = resp;
        } else {
            console.error("Element with ID '" + id + "' not found.");
        }
    }

    function onError(reason) {
        console.error('Response promise rejected: ' + reason);
        showResponse('response-from-promise', 'Error: ' + reason);
    }

    grecaptcha.enterprise.ready(function() {
        const loginForm = document.getElementById('login-form');

        loginForm.addEventListener('submit', function(event) {
            event.preventDefault();

            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            grecaptcha.enterprise.execute('{{ siteKey }}', { action: 'login' })
                .then(function(token) {
                    // Send data to the backend.
                    fetch('/login', { // login is a dummy endpoint
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            username: username,
                            password: password,
                            'g-recaptcha-response': token
                        })
                    })
                    .then(response => {
                      if (response.ok) {
                        return response.json();
                      } else {
                        throw new Error('Network response was not ok.');
                      }
                    })
                    .then(data => {
                        if (data.success) {
                           showResponse('response-from-promise', "Login Success");
                        }
                        else {
                           showResponse('response-from-promise', 'Login failed: ' + data.message);
                        }
                    })
                    .catch(error => {
                        onError(error.message);
                    });
                })
                .catch(onError);
        });
    });
});
  </script>
</body>
</html>